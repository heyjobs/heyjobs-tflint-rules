name: 🚀 Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # para goreleaser criar o GitHub Release
      id-token: write    # só necessário se você usar keyless OIDC

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v4

      - name: 🛠️ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'   # ajuste conforme seu projeto

      - name: 🔑 Prepare Cosign key
        run: |
          echo "${{ secrets.COSIGN_KEY }}" > cosign.key
          chmod 400 cosign.key

      - name: 📦 Install Cosign
        run: |
          COSIGN_VERSION=$(grep -oP '(?<=const Version = ")[^"]+' \
            <(curl -sL https://raw.githubusercontent.com/sigstore/cosign/main/cmd/cosign/version.go))
          curl -sSL -o cosign https://github.com/sigstore/cosign/releases/download/v${COSIGN_VERSION}/cosign-linux-amd64
          chmod +x cosign && sudo mv cosign /usr/local/bin/

      - name: 🏗️ Build & Release with Goreleaser
        uses: goreleaser/goreleaser-action@v3
        with:
          version: latest
          args: release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ✍️ Sign artifacts with Cosign
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PWD }}
        run: |
          for bin in dist/*/*/*; do
            echo "Signing $bin"
            cosign sign --key cosign.key "$bin"
          done